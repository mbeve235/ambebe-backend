// Prisma schema for PostgreSQL


generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
  directUrl = env("POSTGRES_URL")
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum ImageProvider {
  LOCAL
  EXTERNAL
  S3
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  CANCELED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
}

enum CouponType {
  PERCENT
  FIXED
}

enum SupportStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
}

model User {
  id                  String               @id @default(uuid()) @db.Char(36)
  email               String               @unique @db.VarChar(255)
  passwordHash        String               @db.VarChar(255)
  name                String?              @db.VarChar(120)
  roleId              String               @db.Char(36)
  role                Role                 @relation(fields: [roleId], references: [id])
  isEmailVerified     Boolean              @default(true)
  emailVerifiedAt     DateTime?
  lastPasswordResetAt DateTime?
  refreshTokens       RefreshToken[]
  addresses           Address[]
  cart                Cart?
  orders              Order[]
  auditLogs           AuditLog[]           @relation("AuditActor")
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  passwordResetTokens PasswordResetToken[] @relation("UserPasswordResetTokens")
  emailVerificationTokens EmailVerificationToken[] @relation("UserEmailVerificationTokens")
  supportMessages     SupportMessage[]     @relation("UserSupportMessages")
  supportReplies      SupportReply[]       @relation("SupportReplyAuthor")
  notificationPreference NotificationPreference?
}

model Role {
  id          String           @id @default(uuid()) @db.Char(36)
  name        String           @unique @db.VarChar(50)
  permissions RolePermission[]
  users       User[]
}

model Permission {
  id          String           @id @default(uuid()) @db.Char(36)
  code        String           @unique @db.VarChar(100)
  description String?          @db.VarChar(255)
  roles       RolePermission[]
}

model RolePermission {
  roleId       String     @db.Char(36)
  permissionId String     @db.Char(36)
  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

model RefreshToken {
  id                String    @id @default(uuid()) @db.Char(36)
  userId            String    @db.Char(36)
  user              User      @relation(fields: [userId], references: [id])
  tokenHash         String    @db.VarChar(255)
  expiresAt         DateTime
  revokedAt         DateTime?
  replacedByTokenId String?   @db.Char(36)
  createdAt         DateTime  @default(now())
}

model PasswordResetToken {
  id        String    @id @default(uuid()) @db.Char(36)
  userId    String    @db.Char(36)
  user      User      @relation("UserPasswordResetTokens", fields: [userId], references: [id])
  tokenHash String    @unique @db.VarChar(255)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
}

model EmailVerificationToken {
  id        String   @id @default(uuid()) @db.Char(36)
  userId    String   @db.Char(36)
  user      User     @relation("UserEmailVerificationTokens", fields: [userId], references: [id])
  tokenHash String   @unique @db.VarChar(255)
  codeHash  String   @db.VarChar(255)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId])
}

model SupportMessage {
  id        String        @id @default(uuid()) @db.Char(36)
  userId    String        @db.Char(36)
  user      User          @relation("UserSupportMessages", fields: [userId], references: [id])
  subject   String        @db.VarChar(200)
  message   String        @db.VarChar(3000)
  status    SupportStatus @default(OPEN)
  isRead    Boolean       @default(false)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  replies   SupportReply[] @relation("SupportMessageReplies")

  @@index([userId])
  @@index([status])
  @@index([isRead])
}

model SupportReply {
  id               String        @id @default(uuid()) @db.Char(36)
  supportMessageId String        @db.Char(36)
  supportMessage   SupportMessage @relation("SupportMessageReplies", fields: [supportMessageId], references: [id])
  authorId         String        @db.Char(36)
  author           User          @relation("SupportReplyAuthor", fields: [authorId], references: [id])
  message          String        @db.VarChar(3000)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([supportMessageId])
  @@index([authorId])
}

model LoginAttempt {
  id            String   @id @default(uuid()) @db.Char(36)
  email         String   @unique @db.VarChar(255)
  failureCount  Int      @default(0)
  lockedUntil   DateTime?
  lastFailureAt DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Branding {
  id          String   @id @default(uuid()) @db.Char(36)
  key         String   @unique @db.VarChar(50)
  logoUrl     String?  @db.VarChar(500)
  logoKey     String?  @db.VarChar(255)
  faviconUrl  String?  @db.VarChar(500)
  faviconKey  String?  @db.VarChar(255)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Category {
  id          String            @id @default(uuid()) @db.Char(36)
  name        String            @db.VarChar(120)
  slug        String            @unique @db.VarChar(120)
  description String?           @db.VarChar(500)
  products    ProductCategory[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

model Product {
  id          String            @id @default(uuid()) @db.Char(36)
  name        String            @db.VarChar(200)
  slug        String            @unique @db.VarChar(200)
  description String?           @db.VarChar(2000)
  status      ProductStatus     @default(DRAFT)
  basePrice   Decimal           @db.Decimal(12, 2)
  categories  ProductCategory[]
  variants    ProductVariant[]
  images      ProductImage[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

model ProductCategory {
  productId  String   @db.Char(36)
  categoryId String   @db.Char(36)
  product    Product  @relation(fields: [productId], references: [id])
  category   Category @relation(fields: [categoryId], references: [id])

  @@id([productId, categoryId])
}

model ProductVariant {
  id         String     @id @default(uuid()) @db.Char(36)
  productId  String     @db.Char(36)
  product    Product    @relation(fields: [productId], references: [id])
  sku        String     @unique @db.VarChar(100)
  name       String     @db.VarChar(200)
  price      Decimal    @db.Decimal(12, 2)
  attributes Json
  stockItem  StockItem?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

model ProductImage {
  id         String        @id @default(uuid()) @db.Char(36)
  productId  String        @db.Char(36)
  product    Product       @relation(fields: [productId], references: [id])
  url        String        @db.VarChar(500)
  storageKey String?       @db.VarChar(255)
  provider   ImageProvider @default(LOCAL)
  mimeType   String?       @db.VarChar(120)
  sizeBytes  Int?
  sortOrder  Int           @default(0)
  createdAt  DateTime      @default(now())
}

model StockItem {
  id        String          @id @default(uuid()) @db.Char(36)
  variantId String          @unique @db.Char(36)
  variant   ProductVariant  @relation(fields: [variantId], references: [id])
  onHand    Int             @default(0)
  movements StockMovement[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
}

model StockMovement {
  id          String    @id @default(uuid()) @db.Char(36)
  stockItemId String    @db.Char(36)
  stockItem   StockItem @relation(fields: [stockItemId], references: [id])
  delta       Int
  reason      String    @db.VarChar(255)
  createdAt   DateTime  @default(now())
}

model Cart {
  id        String     @id @default(uuid()) @db.Char(36)
  userId    String     @unique @db.Char(36)
  user      User       @relation(fields: [userId], references: [id])
  items     CartItem[]
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id                 String   @id @default(uuid()) @db.Char(36)
  cartId             String   @db.Char(36)
  cart               Cart     @relation(fields: [cartId], references: [id])
  productId          String   @db.Char(36)
  variantId          String?  @db.Char(36)
  quantity           Int
  priceSnapshot      Decimal  @db.Decimal(12, 2)
  nameSnapshot       String   @db.VarChar(200)
  skuSnapshot        String   @db.VarChar(100)
  attributesSnapshot Json
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Order {
  id            String        @id @default(uuid()) @db.Char(36)
  userId        String        @db.Char(36)
  user          User          @relation(fields: [userId], references: [id])
  status        OrderStatus   @default(PENDING)
  total         Decimal       @db.Decimal(12, 2)
  discountTotal Decimal       @default(0) @db.Decimal(12, 2)
  couponId      String?       @db.Char(36)
  couponCode    String?       @db.VarChar(50)
  coupon        Coupon?       @relation(fields: [couponId], references: [id])
  currency      String        @default("MZN") @db.VarChar(3)
  paymentStatus PaymentStatus @default(PENDING)
  items         OrderItem[]
  payment       Payment?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Coupon {
  id              String     @id @default(uuid()) @db.Char(36)
  code            String     @unique @db.VarChar(50)
  description     String?    @db.VarChar(255)
  type            CouponType
  value           Decimal    @db.Decimal(12, 2)
  minSubtotal     Decimal?   @db.Decimal(12, 2)
  maxRedemptions  Int?
  redemptionCount Int        @default(0)
  startsAt        DateTime?
  endsAt          DateTime?
  isActive        Boolean    @default(true)
  orders          Order[]
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model OrderItem {
  id                 String  @id @default(uuid()) @db.Char(36)
  orderId            String  @db.Char(36)
  order              Order   @relation(fields: [orderId], references: [id])
  productId          String? @db.Char(36)
  variantId          String? @db.Char(36)
  quantity           Int
  priceSnapshot      Decimal @db.Decimal(12, 2)
  nameSnapshot       String  @db.VarChar(200)
  skuSnapshot        String  @db.VarChar(100)
  attributesSnapshot Json
}

model Payment {
  id          String        @id @default(uuid()) @db.Char(36)
  orderId     String        @unique @db.Char(36)
  order       Order         @relation(fields: [orderId], references: [id])
  status      PaymentStatus @default(PENDING)
  amount      Decimal       @db.Decimal(12, 2)
  provider    String?       @db.VarChar(100)
  externalRef String?       @db.VarChar(200)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Address {
  id         String   @id @default(uuid()) @db.Char(36)
  userId     String   @db.Char(36)
  user       User     @relation(fields: [userId], references: [id])
  name       String   @db.VarChar(120)
  line1      String   @db.VarChar(200)
  line2      String?  @db.VarChar(200)
  city       String   @db.VarChar(120)
  state      String   @db.VarChar(120)
  postalCode String   @db.VarChar(40)
  country    String   @db.VarChar(2)
  phone      String?  @db.VarChar(30)
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model AuditLog {
  id        String   @id @default(uuid()) @db.Char(36)
  actorId   String?  @db.Char(36)
  actor     User?    @relation("AuditActor", fields: [actorId], references: [id])
  action    String   @db.VarChar(120)
  entity    String   @db.VarChar(120)
  entityId  String?  @db.VarChar(120)
  meta      Json
  createdAt DateTime @default(now())
}

model IdempotencyKey {
  id           String   @id @default(uuid()) @db.Char(36)
  key          String   @db.VarChar(120)
  userId       String   @db.Char(36)
  requestHash  String   @db.VarChar(255)
  responseBody Json
  createdAt    DateTime @default(now())
  expiresAt    DateTime

  @@unique([key, userId])
}

model NotificationPreference {
  id                           String   @id @default(uuid()) @db.Char(36)
  userId                       String   @unique @db.Char(36)
  user                         User     @relation(fields: [userId], references: [id])
  newProductNotificationsEnabled Boolean @default(true)
  lastProductSeenAt            DateTime?
  lastSupportSeenAt            DateTime?
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt
}
